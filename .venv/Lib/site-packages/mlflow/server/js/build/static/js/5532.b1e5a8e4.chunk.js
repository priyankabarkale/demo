"use strict";(self.webpackChunk_mlflow_mlflow=self.webpackChunk_mlflow_mlflow||[]).push([[5532],{32874:function(e,t,a){a.d(t,{Z:function(){return h}});var n=a(27757),s=a(82716),r=a(46709),o=a(40724),i=a(79081),l=a(66916),c=a(42747),d=a(61077),u=a(39595),f=a(61060),m=a(34599);var p=a(73408);const g=({visible:e,experimentId:t,onCancel:a})=>{const{theme:o}=(0,n.u)(),g=(0,c.tz)(),[v,h]=(0,r.useState)(""),[_,x]=(0,r.useState)(""),{createEvaluationDatasetMutation:w,isLoading:y}=(({onSuccess:e,onError:t})=>{const a=(0,u.jE)(),{mutate:n,isLoading:s}=(0,f.n)({mutationFn:async({datasetName:e,experimentIds:t})=>{const a={name:e,experiment_ids:t};return(await(0,d.ff)((0,d.we)("ajax-api/3.0/mlflow/datasets/create"),"POST",a)).dataset},onSuccess:()=>{a.invalidateQueries({queryKey:[m.P4]}),null===e||void 0===e||e()},onError:e=>{null===t||void 0===t||t(e)}});return{createEvaluationDatasetMutation:n,isLoading:s}})({onSuccess:()=>{a()}}),I=(0,r.useCallback)(()=>{v?w({datasetName:v,experimentIds:[t]}):x(g.formatMessage({id:"sbHChH",defaultMessage:"Dataset name is required"}))},[w,t,v,g]);return(0,p.FD)(i.d,{componentId:"mlflow.create-evaluation-dataset-modal",visible:e,onCancel:a,okText:g.formatMessage({id:"creoEe",defaultMessage:"Create"}),cancelText:g.formatMessage({id:"nEnDEu",defaultMessage:"Cancel"}),onOk:I,okButtonProps:{loading:y,disabled:!v},title:(0,p.Y)(c.sA,{id:"287Ack",defaultMessage:"Create evaluation dataset"}),zIndex:o.options.zIndexBase+20,children:[(0,p.Y)(s.FormUI.Label,{htmlFor:"dataset-name-input",children:(0,p.Y)(c.sA,{id:"xdFMIN",defaultMessage:"Dataset name"})}),(0,p.Y)(l.I,{componentId:"mlflow.create-evaluation-dataset-modal.dataset-name",id:"dataset-name-input",name:"name",type:"text",placeholder:g.formatMessage({id:"ZQpc2w",defaultMessage:"Enter dataset name"}),value:v,onChange:e=>{h(e.target.value),x("")}}),_&&(0,p.Y)(s.FormUI.Message,{type:"error",message:_})]})};var v={name:"b9l38d",styles:"width:min-content"};const h=({experimentId:e})=>{const[t,a]=(0,r.useState)(!1);return(0,p.FD)(p.FK,{children:[(0,p.Y)(n.B,{componentId:"mlflow.eval-datasets.create-dataset-button",css:v,icon:(0,p.Y)(s.DatabaseIcon,{}),onClick:()=>a(!0),children:(0,p.Y)(o.A,{id:"N7BCue",defaultMessage:"Create dataset"})}),(0,p.Y)(g,{experimentId:e,visible:t,onCancel:()=>a(!1)})]})}},34599:function(e,t,a){a.d(t,{Hb:function(){return o},P4:function(){return s},lA:function(){return r},uz:function(){return n}});const n="GET_DATASET_RECORDS",s="SEARCH_EVALUATION_DATASETS",r="FETCH_TRACES",o="CHECK_MULTITURN_DATASETS"},52849:function(e,t,a){a.d(t,{v:function(){return s}});var n=a(46709);const s=({isFetching:e,hasNextPage:t,fetchNextPage:a})=>(0,n.useCallback)(n=>{if(n){const{scrollHeight:s,scrollTop:r,clientHeight:o}=n;s-r-o<200&&!e&&t&&a()}},[a,e,t])},55532:function(e,t,a){a.d(t,{p:function(){return F}});var n=a(68248),s=a(27757),r=a(79081),o=a(82716),i=a(66916),l=a(90061),c=a(43617),d=a(76256),u=a(40724),f=a(52849),m=a(72607),p=a(46709),g=a(58663),v=a(76118),h=a(21723);var _=a(61077),x=a(61060);var w=a(32874),y=a(49708),I=a(69986),S=a(34599);var b=a(60062),T=a(181);var E=a(73408);const C=[{id:"name",accessorKey:"name",header:"Name"}];var A={name:"tardml",styles:"height:500px;overflow:hidden"},R={name:"82a6rk",styles:"flex:1"};const F=({experimentId:e,visible:t,setVisible:a,selectedTraceInfos:F})=>{const{theme:M}=(0,s.u)(),[D,k]=(0,p.useState)(""),[N,P]=(0,p.useState)(D),Y=F.map(e=>(0,g.MF)({info:e,data:{spans:[]}})),{data:z,isLoading:H}=(({traceIds:e})=>(0,y.I)({queryKey:[S.lA,e],queryFn:async({queryKey:[,e]})=>{const t=(0,v.chunk)(e,20),a=[];for(const n of t){const e=await Promise.all(n.map(e=>(0,I.Uv)(e)));a.push(...e)}return a}}))({traceIds:Y}),L=(e=>{const t=e.map(e=>{const t=e.data.spans.find(e=>!(0,g.cp)(e));if((0,v.isNil)(t))return null;const a={};if((0,g.gD)(e.info))for(const r of null!==(n=e.info.assessments)&&void 0!==n?n:[]){var n;if("expectation"in r)if("serialized_value"in r.expectation){const e=r.expectation.serialized_value.value;try{a[r.assessment_name]=JSON.parse(e)}catch(s){a[r.assessment_name]=e}}else a[r.assessment_name]=r.expectation.value}return{inputs:(0,g.UZ)(t)||(0,g.$f)(t)?(0,g.xD)((0,h.zl)(t.attributes,"mlflow.spanInputs")):t.inputs,expectations:a,source:{source_type:"TRACE",source_data:{trace_id:(0,g.MF)(e)}}}});return(0,v.compact)(t)})((0,v.compact)(z)),{data:O,isLoading:K,isFetching:q,fetchNextPage:J,hasNextPage:U}=(0,m.J)({experimentId:e,nameFilter:D}),B=K||H,W=(0,f.v)({isFetching:q,hasNextPage:null!==U&&void 0!==U&&U,fetchNextPage:J}),Z=(0,d.L)("mlflow/server/js/src/experiment-tracking/pages/experiment-evaluation-datasets/components/ExportTracesToDatasetModal.tsx",{columns:C,getRowId:e=>e.dataset_id,data:null!==O&&void 0!==O?O:[],getCoreRowModel:(0,l.HT)(),enableColumnResizing:!1}),j=Z.getSelectedRowModel().rows.map(e=>e.original),V=j.map(e=>e.dataset_id),{data:$=!1,isLoading:G}=(({datasetIds:e})=>{const t=(0,b.E)({queries:e.map(e=>({queryKey:[S.Hb,e],queryFn:async()=>{const t=new URLSearchParams;t.set("dataset_id",e),t.set("max_results","1");const a=await(0,_.ff)((0,_.we)(`ajax-api/3.0/mlflow/datasets/${e}/records?${t.toString()}`),"GET").catch(()=>null);if(!a)return!1;const n=(0,T.pt)(a.records);if(n&&n.length>0){const e=n[0].inputs;if(e&&e.goal)return!0}return!1},refetchOnWindowFocus:!1}))});return{isLoading:t.some(e=>e.isLoading),data:t.some(e=>!0===e.data)}})({datasetIds:V}),{upsertDatasetRecordsMutation:Q,isLoading:X}=(({onSuccess:e,onError:t})=>{const{mutate:a,isLoading:n}=(0,x.n)({mutationFn:async({datasetId:e,records:t})=>{const a={dataset_id:e,records:t};return await(0,_.ff)((0,_.we)(`ajax-api/3.0/mlflow/datasets/${e}/records`),"POST",a)},onSuccess:()=>{null===e||void 0===e||e()},onError:e=>{null===t||void 0===t||t(e)}});return{upsertDatasetRecordsMutation:a,isLoading:n}})({onSuccess:()=>{a(!1)}}),ee=(0,p.useCallback)(()=>{Promise.all(j.map(e=>Q({datasetId:e.dataset_id,records:JSON.stringify(L)})))},[j,Q,L]);return(0,E.Y)(r.d,{componentId:"mlflow.export-traces-to-dataset-modal",visible:t,onCancel:()=>a(!1),okText:(0,E.Y)(u.A,{id:"a1liZ7",defaultMessage:"Export"}),okButtonProps:{disabled:H||0===j.length||$||G,loading:X},onOk:ee,title:(0,E.Y)(u.A,{id:"ZBRK9J",defaultMessage:"Export traces to datasets"}),zIndex:M.options.zIndexBase+10,children:(0,E.FD)("div",{css:A,children:[$&&(0,E.Y)(o.Alert,{componentId:"mlflow.export-traces-to-dataset-modal.multiturn-error",type:"error",css:(0,n.AH)({marginBottom:M.spacing.sm},""),message:(0,E.Y)(u.A,{id:"FhnIR9",defaultMessage:"Exporting to multi-turn datasets is not yet supported."}),closable:!1}),(0,E.FD)("div",{css:(0,n.AH)({display:"flex",gap:M.spacing.sm,alignItems:"center",marginBottom:M.spacing.sm},""),children:[(0,E.Y)(i.I,{allowClear:!0,placeholder:"Search by dataset name",value:N,onChange:e=>{P(e.target.value),e.target.value||k(e.target.value)},onClear:()=>{P(""),k("")},onPressEnter:()=>k(N),componentId:"mlflow.eval-datasets.search-input",css:R,prefix:(0,E.Y)(i.S,{})}),(0,E.Y)(w.Z,{experimentId:e})]}),(0,E.FD)(o.Table,{scrollable:!0,onScroll:e=>W(e.currentTarget),someRowsSelected:Z.getIsSomeRowsSelected()||Z.getIsAllRowsSelected(),empty:!K&&!q&&0===O.length&&(0,E.Y)(o.Empty,{description:(0,E.Y)(u.A,{id:"F4K195",defaultMessage:"No evaluation datasets found"})}),children:[(0,E.FD)(o.TableRow,{isHeader:!0,children:[(0,E.Y)(o.TableRowSelectCell,{componentId:"mlflow.export-traces-to-dataset-modal.header-checkbox",checked:Z.getIsAllRowsSelected(),indeterminate:Z.getIsSomeRowsSelected(),onChange:Z.getToggleAllRowsSelectedHandler()}),Z.getLeafHeaders().map(e=>(0,E.Y)(o.TableHeader,{componentId:"mlflow.eval-datasets.column-header",header:e,column:e.column,css:(0,n.AH)({width:e.column.columnDef.size,maxWidth:e.column.columnDef.maxSize},""),children:(0,c.Kv)(e.column.columnDef.header,e.getContext())},e.id))]}),!B&&Z.getRowModel().rows.map(e=>(0,E.FD)(o.TableRow,{children:[(0,E.Y)("div",{children:(0,E.Y)(o.TableRowSelectCell,{componentId:"mlflow.export-traces-to-dataset-modal.row-checkbox",checked:e.getIsSelected(),onChange:e.getToggleSelectedHandler()})}),e.getVisibleCells().map(e=>(0,E.Y)(o.TableCell,{css:(0,n.AH)({width:e.column.columnDef.size,maxWidth:e.column.columnDef.maxSize},""),children:(0,c.Kv)(e.column.columnDef.cell,e.getContext())},e.id))]},e.id)),(B||q)&&(0,E.Y)(o.TableSkeletonRows,{table:Z})]})]})})}},69986:function(e,t,a){a.d(t,{RT:function(){return p},Rb:function(){return c},Uv:function(){return l},a_:function(){return g},fz:function(){return v},lc:function(){return _}});var n=a(12803),s=a(58663),r=a(71540),o=a(13433),i=a(21723);async function l(e,t){if(e){if((0,r.ZZ)(t)===r.Cf){const t=await(0,o.UA)({traceId:e});if(null!==t&&void 0!==t&&t.trace&&t.trace.data)return{info:t.trace.trace_info||{},data:t.trace.data}}return(0,s.ho)(e)?s._A.getTraceV4(e):e.startsWith("tr-")?s.TJ.getTraceV3(e):c(e)}}async function c(e){if(!e)return;const[t,a]=await Promise.all([n.x.getExperimentTraceInfo(e).then(e=>e.trace_info||{}),n.x.getExperimentTraceData(e)]);return a?{info:t,data:a}:void 0}function d(e){if("trace_id"in e&&"span_id"in e){return!e.parent_span_id}const t=e;return!t.parent_span_id&&!t.parent_id}function u(e){var t;return((null===(t=e.data)||void 0===t?void 0:t.spans)||[]).find(d)||null}function f(e){return"string"===typeof e?e:JSON.stringify(e)}function m(e,t,a){if(t in e){const a=e[t];if(void 0!==a)return f(a)}return void 0!==(0,i.zl)(e.attributes,a)?f((0,i.zl)(e.attributes,a)):null}function p(e){const t=u(e);return t?m(t,"inputs","mlflow.spanInputs"):null}function g(e){const t=u(e);return t?m(t,"outputs","mlflow.spanOutputs"):null}function v(e){const t={},a=e.info;return a.assessments&&Array.isArray(a.assessments)?(a.assessments.forEach(e=>{var a;if(!function(e){return"expectation"in e}(e))return;if(!1===e.valid)return;if("HUMAN"!==(null===(a=e.source)||void 0===a?void 0:a.source_type))return;const n=function(e){if("value"in e)return e.value;if("serialized_value"in e&&e.serialized_value)try{return JSON.parse(e.serialized_value.value)}catch{return e.serialized_value.value}return null}(e.expectation);void 0!==n&&null!==n&&(t[e.assessment_name]=n)}),t):t}function h(e){if("trace_id"in e&&"span_id"in e){var t;let a=null===(t=e.attributes)||void 0===t?void 0:t["mlflow.spanType"];if("string"===typeof a&&a.startsWith('"')&&a.endsWith('"'))try{a=JSON.parse(a)}catch{}return"RETRIEVER"===a}let a=e.span_type;if("string"===typeof a&&a.startsWith('"')&&a.endsWith('"'))try{a=JSON.parse(a)}catch{}return"RETRIEVER"===a}function _(e){const t=function(e){var t;const a=(null===(t=e.data)||void 0===t?void 0:t.spans)||[];if(0===a.length)return[];const n=a.filter(h);if(0===n.length)return[];const s=new Set;for(const o of n){const e="span_id"in o?o.span_id:o.context.span_id;e&&s.add(e)}const r=[];for(const o of n){let e,t=!0;if("trace_id"in o&&"span_id"in o)e=o.parent_span_id;else{const t=o;e=t.parent_span_id||t.parent_id}for(;e;){if(s.has(e)){t=!1;break}let n;for(const t of a)if(("span_id"in t?t.span_id:t.context.span_id)===e){n=t;break}if(!n)break;if("trace_id"in n&&"span_id"in n)e=n.parent_span_id;else{const t=n;e=t.parent_span_id||t.parent_id}}t&&r.push(o)}return r}(e);if(0===t.length)return null;const a=[];for(const r of t){let e=[],t="",o="";if("trace_id"in r&&"span_id"in r){var n;const a=r;t=a.span_id||"",o=a.name||t;let s=null===(n=a.attributes)||void 0===n?void 0:n["mlflow.spanOutputs"];if("string"===typeof s)try{s=JSON.parse(s)}catch{continue}s&&"object"===typeof s&&Array.isArray(s)&&(e=s.map(e=>{var t;return{doc_uri:e.doc_uri||e.uri||(null===(t=e.metadata)||void 0===t?void 0:t.doc_uri)||"",content:e.content||e.page_content||""}}))}else{var s;const a=r;t=(null===(s=a.context)||void 0===s?void 0:s.span_id)||"",o=a.name||t,a.outputs&&Array.isArray(a.outputs)&&(e=a.outputs.map(e=>({doc_uri:e.doc_uri||e.uri||"",content:e.content||e.page_content||""})))}e.length>0&&a.push({span_id:t,span_name:o,documents:e})}return 0===a.length?null:{retrieved_documents:a}}},72607:function(e,t,a){a.d(t,{J:function(){return i}});var n=a(96584),s=a(61077),r=a(46709),o=a(34599);const i=({experimentId:e,enabled:t=!0,nameFilter:a=""})=>{const{data:i,fetchNextPage:l,hasNextPage:c,isLoading:d,isFetching:u,refetch:f,error:m}=(0,n.q)({queryKey:[o.P4,e,a],queryFn:async({queryKey:[,e,t],pageParam:a})=>{const n={experiment_ids:[e],filter_string:t?`name ILIKE '%${t}%'`:void 0,order_by:["created_time DESC"],max_results:50,page_token:a};return await(0,s.ff)((0,s.we)("ajax-api/3.0/mlflow/datasets/search"),"POST",n)},cacheTime:0,refetchOnWindowFocus:!1,retry:!1,enabled:t,getNextPageParam:e=>e.next_page_token});return{data:(0,r.useMemo)(()=>{var e;return null!==(e=null===i||void 0===i?void 0:i.pages.flatMap(e=>{var t;return null!==(t=e.datasets)&&void 0!==t?t:[]}))&&void 0!==e?e:[]},[i]),fetchNextPage:l,hasNextPage:c,isLoading:d,isFetching:u,refetch:f,error:m}}}}]);